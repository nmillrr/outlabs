# Progress Log

## Learnings
(Patterns discovered during implementation)
- Use `python3` not `python` on this machine
- Project root is `egfr-calculator/`, package is `eGFR/`

---

## Iteration 1 - US-001: Create project structure and dependencies
- Created `eGFR/` package with `__init__.py`, `models.py`, `utils.py`, `data.py`, `train.py`, `evaluate.py`, `predict.py`
- Created `tests/` with `test_models.py`, `test_utils.py`
- Created `notebooks/` directory
- Created `requirements.txt` with all specified dependencies
- All imports verified, typecheck passes, pytest runs clean
- Files changed: eGFR/__init__.py, eGFR/models.py, eGFR/utils.py, eGFR/data.py, eGFR/train.py, eGFR/evaluate.py, eGFR/predict.py, tests/__init__.py, tests/test_models.py, tests/test_utils.py, notebooks/README.md, requirements.txt
- Learnings for future iterations:
  - python3 is the correct command (not python)
  - All modules have docstrings as required
  - Git working from project root
---

## Iteration 2 - US-002: Implement unit conversion utilities
- Implemented 6 functions in `eGFR/utils.py`: creatinine_mgdl_to_umoll, creatinine_umoll_to_mgdl, egfr_to_ckd_stage, lbs_to_kg, kg_to_lbs, inches_to_cm, cm_to_inches
- Wrote 23 tests in `tests/test_utils.py` covering all conversions, boundary cases, and roundtrips
- All tests pass
- Files changed: eGFR/utils.py, tests/test_utils.py, PRD.md
- Learnings for future iterations:
  - pytest.approx is useful for float comparison
  - KDIGO 2012 CKD stages: G1≥90, G2≥60, G3a≥45, G3b≥30, G4≥15, G5<15
  - egfr_to_ckd_stage is available in utils for future use by models and evaluate modules
---

## Iteration 3 - US-003: Create NHANES kidney data download module
- Implemented `download_nhanes_kidney(output_dir, cycles)` in `eGFR/data.py`
- Downloads BIOPRO, DEMO, BMX for 2005-2018 cycles and SSPRT cystatin C for 1999-2002
- Uses `urllib.request.urlretrieve` (stdlib only, no extra dependencies)
- Graceful error handling for HTTP errors, network errors, and file errors
- Skip-if-exists logic to avoid redundant downloads
- Creates `data/raw/` with `os.makedirs(exist_ok=True)`
- Returns summary dict with `downloaded` and `failed` lists
- All 23 existing tests pass, typecheck passes
- Files changed: eGFR/data.py, PRD.md, progress.txt
- Learnings for future iterations:
  - PowerShell uses `;` not `&&` for chaining commands
  - `_CYCLE_SUFFIX` dict maps NHANES cycles to CDC filename suffixes
  - NHANES URL pattern: `https://wwwn.cdc.gov/Nchs/Nhanes/{cycle}/{DATASET}{suffix}.XPT`
  - SSPRT (cystatin C) only available for 1999-2002 cycles
---

## Iteration 4 - US-004: Implement XPT file parser
- Added `read_xpt(filepath)` function in `eGFR/data.py` using `pd.read_sas(format='xport')`
- Raises `FileNotFoundError` for missing files with informative message
- Raises `ValueError` for corrupt/unparseable files (wraps underlying exceptions)
- Created `tests/test_data.py` with 6 tests using `unittest.mock` for happy-path and real files for error-path
- All 29 tests pass (6 new + 23 existing)
- Files changed: eGFR/data.py, tests/test_data.py, PRD.md, progress.txt
- Learnings for future iterations:
  - `pd.DataFrame.to_sas()` does not exist in pandas 2.3.3 — cannot write XPT from Python easily
  - Use `unittest.mock.patch("eGFR.data.pd.read_sas")` to mock XPT reading in tests
  - SAS XPORT V5 binary format is complex; mocking is more practical than constructing test binaries
  - `pd.read_sas(path, format="xport", encoding="utf-8")` is the correct call for XPT files
---

## Iteration 5 - US-005: Create NHANES kidney data cleaning pipeline
- Added `clean_kidney_data(biopro_df, demo_df, bmx_df, cystatin_df=None, *, apply_idms_correction=False)` in `eGFR/data.py`
- Merges BIOPRO, DEMO, BMX on SEQN (inner join), optionally merges cystatin C (left join)
- Renames columns: LBXSCR→cr_mgdl, RIDAGEYR→age_years, RIAGENDR→sex, BMXWT→weight_kg, BMXHT→height_cm, SSPRT→cystatin_c_mgL
- IDMS correction: multiplies creatinine by 0.95 when `apply_idms_correction=True` (for pre-2007 cycles)
- Removes outliers: creatinine < 0.2 or > 15 mg/dL, age < 18
- Drops NaN in core columns, resets index
- Added `_validate_columns()` helper for input validation
- Wrote 20 tests in `tests/test_data.py` (total: 49 tests pass)
- Files changed: eGFR/data.py, tests/test_data.py, PRD.md, progress.txt
- Learnings for future iterations:
  - Terminal output encoding issues with pytest-sugar Unicode characters on Windows; use `-p no:sugar` and `-q` for cleaner output
  - Dict-based rename mapping pattern (`_BIOPRO_RENAME`, `_DEMO_RENAME`, etc.) keeps column mapping maintainable
  - `warnings.warn()` is the right approach for non-fatal data quality issues (outlier removal)
  - `_validate_columns()` pattern gives clear error messages for missing columns
---

## Iteration 6 - US-006: Generate data quality report
- Added `generate_quality_report(df, output_path)` in `eGFR/data.py`
- Report includes: record count, mean/SD for creatinine/age/weight/height/cystatin C (if present)
- CKD stage distribution computed via private `_calc_ckd_epi_2021()` helper + `egfr_to_ckd_stage()` from utils
- Sex distribution breakdown with counts and percentages
- Saves report as text file, auto-creates parent directories
- Returns report text as string
- Added `_calc_ckd_epi_2021()` private helper (CKD-EPI 2021 equation) since models.py is not yet implemented
- Added 13 tests in `tests/test_data.py` (total: 62 tests pass)
- Files changed: eGFR/data.py, tests/test_data.py, PRD.md, progress.txt
- Learnings for future iterations:
  - `_calc_ckd_epi_2021()` is a private helper; when US-008 implements models.py, consider refactoring to use the public API
  - `value_counts()` returns a Series; use `.get(key, default)` for safe access
  - `list[str]` type hint works in Python 3.9+ (no need for `List[str]` from typing)
---

## Iteration 7 - US-007: Create data sourcing notebook
- Created `notebooks/01_data_sourcing.ipynb` with 5 sections: download, parse, clean, quality report, visualizations
- Demonstrates full pipeline: `download_nhanes_kidney()` → `read_xpt()` → `clean_kidney_data()` → `generate_quality_report()`
- Gracefully falls back to synthetic demo data when real XPT files are unavailable
- 4 visualizations: creatinine histogram (overall + by sex), age/sex demographics, creatinine-vs-age scatter, CKD stage bar chart
- Uses `matplotlib.use("Agg")` for headless execution compatibility
- Notebook executes without errors (verified via nbconvert)
- All 62 existing tests still pass
- Files changed: notebooks/01_data_sourcing.ipynb, PRD.md, progress.txt
- Learnings for future iterations:
  - Downloaded XPT files from CDC may be HTML error pages (all 20905 bytes); always validate parsed data
  - `matplotlib.use("Agg")` must come before `import matplotlib.pyplot` for headless environments
  - `_calc_ckd_epi_2021()` from data.py can be imported for notebook CKD stage calculations
  - Synthetic data with `np.random.default_rng()` + lognormal distribution produces realistic creatinine values
---

## Iteration 8 - US-008: Implement CKD-EPI 2021 equation (creatinine-based)
- Added `calc_egfr_ckd_epi_2021(cr_mgdl, age_years, sex)` in `eGFR/models.py`
- Added `_normalize_sex()` helper accepting 'M'/'F' strings and 1/2 NHANES coding
- Full input validation: rejects negative/zero creatinine, NaN, age < 18, invalid sex
- Docstring with Inker et al. (2021) NEJM reference
- Wrote 19 tests in `tests/test_models.py`: known-value checks, NHANES coding, edge cases, validation
- All 86 tests pass (19 new + 67 existing)
- Files changed: eGFR/models.py, tests/test_models.py, PRD.md, progress.txt
- Learnings for future iterations:
  - `_normalize_sex()` in models.py is reusable for MDRD and Cockcroft-Gault (US-010, US-012)
  - PRD expected value for 50F/SCr=0.8 was ~99 but actual CKD-EPI 2021 analytic value is ~89.7
  - `data.py` has a private `_calc_ckd_epi_2021()` helper; consider refactoring to use `models.calc_egfr_ckd_epi_2021()` later
---

## Iteration 9 - US-009: Test CKD-EPI 2021 against known values
- Tests were already implemented in iteration 8 alongside the CKD-EPI 2021 equation
- 24 tests in `tests/test_models.py` all pass: known-value checks (50M/SCr=1.0, 50F/SCr=0.8, 70M/SCr=1.5), NHANES coding, edge cases, and input validation (negative, NaN, age < 18)
- Only change needed: mark US-009 acceptance criteria as [x] in PRD.md
- Files changed: PRD.md
- Learnings for future iterations:
  - US-009 tests were bundled with US-008 implementation — always check if tests already exist before writing new ones
  - PRD acceptance criteria checkboxes should be updated in the same iteration as the implementation
---

## Iteration 10 - US-010: Implement MDRD equation
- Added `calc_egfr_mdrd(cr_mgdl, age_years, sex, is_black=False)` in `eGFR/models.py`
- IDMS-traceable 175 coefficient; formula: 175 × SCr^−1.154 × Age^−0.203 × 0.742 [if female] × 1.212 [if Black]
- Issues `UserWarning` when eGFR > 60 (MDRD less accurate above this threshold)
- Reuses `_normalize_sex()` helper from CKD-EPI 2021 implementation
- Docstring references Levey et al. (2006) Ann Intern Med
- Wrote 16 tests in `tests/test_models.py`: 7 known-value, 2 warning, 6 validation, 1 race coefficient
- All 101 tests pass (16 new + 85 existing)
- Files changed: eGFR/models.py, tests/test_models.py, PRD.md, progress.txt
- Learnings for future iterations:
  - MDRD formula: 175 × SCr^−1.154 × Age^−0.203 yields ~79.1 for 50M/SCr=1.0 (not 75 as hand-calculated)
  - `warnings.catch_warnings(record=True)` + `warnings.simplefilter("always")` is the clean pattern for testing warnings
  - `is_black` race coefficient retained for backward compatibility but KDIGO 2021 discourages its use
  - `_normalize_sex()` reuse confirmed — same helper works for all equation functions
---

## Iteration 11 - US-011: Test MDRD against known values
- Tests were already implemented in iteration 10 alongside the MDRD equation
- 16 tests in `tests/test_models.py`: known-value checks, warning tests, race coefficient, and input validation
- Only change needed: mark US-011 acceptance criteria as [x] in PRD.md
- Files changed: PRD.md
- Learnings for future iterations:
  - US-011 tests were bundled with US-010 — same pattern as US-008/US-009
---

## Iteration 12 - US-012: Implement Cockcroft-Gault equation
- Added `calc_crcl_cockcroft_gault(cr_mgdl, age_years, weight_kg, sex)` in `eGFR/models.py`
- Formula: CrCl = [(140 - Age) × Weight / (72 × SCr)] × 0.85 [if female]
- Returns CrCl in mL/min (NOT normalised to BSA)
- Added BSA-adjusted variant: `calc_crcl_cockcroft_gault_bsa(..., height_cm)` using DuBois BSA formula
- BSA (DuBois) = 0.007184 × Height_cm^0.725 × Weight_kg^0.425; adjustment = CrCl × (1.73 / BSA)
- Full input validation for cr_mgdl, age_years, weight_kg, sex, height_cm
- Docstrings reference Cockcroft & Gault (1976) Nephron and DuBois (1916)
- Added 23 tests in `tests/test_models.py`: 8 known-value, 9 validation, 6 BSA-adjusted
- All 124 tests pass (23 new + 101 existing)
- Files changed: eGFR/models.py, tests/test_models.py, PRD.md, progress.txt
- Learnings for future iterations:
  - CG formula is weight-dependent unlike CKD-EPI/MDRD — weight_kg is a required parameter
  - BSA adjustment uses DuBois formula; at BSA=1.73 m², adjusted ≈ unadjusted
  - CrCl (mL/min) ≠ eGFR (mL/min/1.73 m²) — important distinction for drug dosing
  - `calc_crcl_cockcroft_gault_bsa` delegates to `calc_crcl_cockcroft_gault` for DRY validation
---

## Iteration 13 - US-013: Test Cockcroft-Gault against known values
- Tests were already implemented in iteration 12 alongside the Cockcroft-Gault equation
- 23 tests in `tests/test_models.py`: 8 known-value (including 70M/70kg/SCr=1.0→CrCl≈68), 9 validation, 6 BSA-adjusted
- All 62 tests pass
- Only change needed: mark US-013 acceptance criteria as [x] in PRD.md
- Files changed: PRD.md
- Learnings for future iterations:
  - US-013 tests were bundled with US-012 — same pattern as US-008/US-009 and US-010/US-011
---

## Iteration 14 - US-014: Create estimator comparison notebook
- Created `notebooks/02_estimator_comparison.ipynb` with 9 code cells and 6 markdown sections
- Compares CKD-EPI 2021 vs MDRD vs Cockcroft-Gault on synthetic NHANES-like data (falls back from real XPT gracefully)
- Scatter plots: CKD-EPI vs MDRD, CKD-EPI vs Cockcroft-Gault with identity lines and CKD threshold markers
- CKD stage reclassification matrices (crosstab + heatmap visualisation) for both comparisons
- Distribution overlay histogram of all three estimators with CKD stage boundary annotations
- Detailed clinical interpretation: CKD-EPI vs MDRD agreement, CrCl vs eGFR distinction, drug dosing implications
- Notebook executes without errors (verified via nbconvert: 9 code cells, 0 error outputs)
- All 124 existing tests still pass
- Files changed: notebooks/02_estimator_comparison.ipynb, PRD.md, progress.txt
- Learnings for future iterations:
  - `python -m nbconvert` works on this machine; `python -m jupyter nbconvert` does not (jupyter entry point issue)
  - Suppress MDRD warnings with `warnings.simplefilter("ignore", UserWarning)` during batch computation
  - `pd.crosstab` + `.reindex()` is a clean pattern for reclassification matrices with guaranteed stage ordering
  - Notebook follows same synthetic-data fallback pattern as notebook 01
---

## Iteration 15 - US-015: Create feature engineering module
- Added `create_features(df)` in `eGFR/train.py` returning `(X, feature_names)` tuple
- 4 feature groups: base clinical (6), optional cystatin C (2), mechanistic estimators (3), derived (3)
- Base: cr_mgdl, age_years, sex_numeric (0=M, 1=F), weight_kg, height_cm, bmi
- Cystatin C (optional): cystatin_c_mgL, cr_cys_ratio — only added if column exists in input
- Estimators: egfr_ckd_epi_2021, egfr_mdrd, crcl_cockcroft_gault — wrapped in _safe_* helpers to return NaN on invalid rows
- Derived: inv_creatinine (1/cr), log_creatinine (ln(cr)), age_cr_interaction (age×cr)
- Input validation: raises ValueError if required columns missing
- 12 features without cystatin, 14 with cystatin
- All 124 existing tests pass, typecheck passes
- Files changed: eGFR/train.py, PRD.md, progress.txt
- Learnings for future iterations:
  - `_safe_*` wrapper pattern prevents single bad rows from crashing feature engineering
  - `_sex_to_numeric()` maps NHANES 1/2 → 0.0/1.0 (different from _normalize_sex which maps to 'M'/'F')
  - Suppress MDRD warnings in `_safe_mdrd` with `warnings.catch_warnings()` context manager
  - BMI computed as weight_kg / (height_cm/100)^2
---

## Iteration 16 - US-016: Implement train/test split with stratification
- Added `stratified_split(df, test_size=0.3, random_state=42)` in `eGFR/train.py`
- Computes CKD-EPI 2021 eGFR as target y, bins into 6 clinical ranges (<15, 15-29, 30-44, 45-59, 60-89, >=90)
- Uses `sklearn.model_selection.train_test_split` with `stratify=` parameter
- Handles tiny bins (< 2 samples) by merging into nearest neighbour bin
- Converts categorical strata to strings to avoid pandas Categorical type issues
- Drops rows where eGFR could not be computed (NaN)
- Raises ValueError for empty DataFrames or missing columns
- Created `tests/test_train.py` with 10 tests: split shapes, ratios, reproducibility, stratification, error handling
- All tests pass (retcode 0), full suite passes
- Files changed: eGFR/train.py, tests/test_train.py, PRD.md, progress.txt
- Learnings for future iterations:
  - `pd.cut(...).astype(str)` avoids categorical type issues when doing `.replace()` on strata
  - `train_test_split` with `stratify=` fails if any stratum has < 2 samples — must merge tiny bins
  - PowerShell terminal output encoding can swallow pytest output; use subprocess + retcode to verify
---

## Iteration 17 - US-017: Train Ridge regression baseline
- Added `train_ridge(X_train, y_train, alpha=1.0)` in `eGFR/train.py`
- Returns fitted `sklearn.linear_model.Ridge` model
- Input validation: rejects empty arrays and mismatched row counts
- Added `save_model(model, filepath)` using `joblib.dump()`
- Creates parent directories if they don't exist, raises ValueError on empty filepath
- Verified both functions work end-to-end: train → save → load → predict
- All 135 tests pass, typecheck passes
- Files changed: eGFR/train.py, PRD.md, progress.txt
- Learnings for future iterations:
  - `joblib` is installed as a dependency of scikit-learn, no need to add to requirements.txt separately
  - Lazy imports (`from sklearn.linear_model import Ridge` inside function body) keep top-level imports clean
  - `save_model()` is generic — works for any joblib-serializable object (Ridge, RF, LightGBM, etc.)
  - `np.asarray(..., dtype=float)` handles both DataFrame and ndarray inputs cleanly
---
