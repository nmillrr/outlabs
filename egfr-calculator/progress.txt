# Progress Log

## Learnings
(Patterns discovered during implementation)
- Use `python3` not `python` on this machine
- Project root is `egfr-calculator/`, package is `eGFR/`

---

## Iteration 1 - US-001: Create project structure and dependencies
- Created `eGFR/` package with `__init__.py`, `models.py`, `utils.py`, `data.py`, `train.py`, `evaluate.py`, `predict.py`
- Created `tests/` with `test_models.py`, `test_utils.py`
- Created `notebooks/` directory
- Created `requirements.txt` with all specified dependencies
- All imports verified, typecheck passes, pytest runs clean
- Files changed: eGFR/__init__.py, eGFR/models.py, eGFR/utils.py, eGFR/data.py, eGFR/train.py, eGFR/evaluate.py, eGFR/predict.py, tests/__init__.py, tests/test_models.py, tests/test_utils.py, notebooks/README.md, requirements.txt
- Learnings for future iterations:
  - python3 is the correct command (not python)
  - All modules have docstrings as required
  - Git working from project root
---

## Iteration 2 - US-002: Implement unit conversion utilities
- Implemented 6 functions in `eGFR/utils.py`: creatinine_mgdl_to_umoll, creatinine_umoll_to_mgdl, egfr_to_ckd_stage, lbs_to_kg, kg_to_lbs, inches_to_cm, cm_to_inches
- Wrote 23 tests in `tests/test_utils.py` covering all conversions, boundary cases, and roundtrips
- All tests pass
- Files changed: eGFR/utils.py, tests/test_utils.py, PRD.md
- Learnings for future iterations:
  - pytest.approx is useful for float comparison
  - KDIGO 2012 CKD stages: G1≥90, G2≥60, G3a≥45, G3b≥30, G4≥15, G5<15
  - egfr_to_ckd_stage is available in utils for future use by models and evaluate modules
---

## Iteration 3 - US-003: Create NHANES kidney data download module
- Implemented `download_nhanes_kidney(output_dir, cycles)` in `eGFR/data.py`
- Downloads BIOPRO, DEMO, BMX for 2005-2018 cycles and SSPRT cystatin C for 1999-2002
- Uses `urllib.request.urlretrieve` (stdlib only, no extra dependencies)
- Graceful error handling for HTTP errors, network errors, and file errors
- Skip-if-exists logic to avoid redundant downloads
- Creates `data/raw/` with `os.makedirs(exist_ok=True)`
- Returns summary dict with `downloaded` and `failed` lists
- All 23 existing tests pass, typecheck passes
- Files changed: eGFR/data.py, PRD.md, progress.txt
- Learnings for future iterations:
  - PowerShell uses `;` not `&&` for chaining commands
  - `_CYCLE_SUFFIX` dict maps NHANES cycles to CDC filename suffixes
  - NHANES URL pattern: `https://wwwn.cdc.gov/Nchs/Nhanes/{cycle}/{DATASET}{suffix}.XPT`
  - SSPRT (cystatin C) only available for 1999-2002 cycles
---

## Iteration 4 - US-004: Implement XPT file parser
- Added `read_xpt(filepath)` function in `eGFR/data.py` using `pd.read_sas(format='xport')`
- Raises `FileNotFoundError` for missing files with informative message
- Raises `ValueError` for corrupt/unparseable files (wraps underlying exceptions)
- Created `tests/test_data.py` with 6 tests using `unittest.mock` for happy-path and real files for error-path
- All 29 tests pass (6 new + 23 existing)
- Files changed: eGFR/data.py, tests/test_data.py, PRD.md, progress.txt
- Learnings for future iterations:
  - `pd.DataFrame.to_sas()` does not exist in pandas 2.3.3 — cannot write XPT from Python easily
  - Use `unittest.mock.patch("eGFR.data.pd.read_sas")` to mock XPT reading in tests
  - SAS XPORT V5 binary format is complex; mocking is more practical than constructing test binaries
  - `pd.read_sas(path, format="xport", encoding="utf-8")` is the correct call for XPT files
---

