# Progress Log

## Learnings
(Patterns discovered during implementation)

---

## Iteration 1 - US-001: Create project structure and dependencies
- Created `freeT/` package with `__init__.py`, `models.py`, `utils.py`, `data.py`
- Created `tests/` directory with `test_models.py`
- Created `notebooks/` directory with `.gitkeep`
- Created `requirements.txt` with all dependencies
- All Python files pass syntax check (`py_compile`)
- Learnings for future iterations:
  - Use PowerShell semicolon (`;`) not `&&` for command chaining on Windows
  - Package init imports submodules for easier access
---

## Iteration 2 - US-002: Implement unit conversion utilities
- Implemented 4 conversion functions in `freeT/utils.py`:
  - `ng_dl_to_nmol_l()` - testosterone ng/dL to nmol/L (factor: 0.0347)
  - `nmol_l_to_ng_dl()` - reverse conversion
  - `mg_dl_to_g_l()` - albumin mg/dL to g/L (factor: 0.01)
  - `g_l_to_mg_dl()` - reverse conversion
- Created `tests/test_utils.py` with 9 test cases covering typical values, edge cases, and roundtrip consistency
- All tests pass via `python -m pytest tests/test_utils.py -v`
- Learnings for future iterations:
  - Use `python -m pytest` instead of `pytest` when pytest isn't in PATH
  - Testosterone conversion factor 0.0347 derived from MW 288.4 g/mol
---

## Iteration 3 - US-003: Create NHANES download module
- Implemented `download_nhanes()` function in `freeT/data.py`
- Function downloads TST, SHBG, ALB XPT files from CDC NHANES website
- Supports cycles 2011-2012, 2013-2014, 2015-2016
- Creates directory structure automatically: `data/raw/{cycle}/`
- Handles HTTP errors, URL errors, and unexpected exceptions gracefully
- Returns summary dict with downloaded/failed/skipped files
- Typecheck passes via `py_compile`
- Learnings for future iterations:
  - NHANES data uses XPT (SAS transport) format
  - Albumin data is in BIOPRO (biochemistry profile) files, not a separate ALB file
  - Use `urllib.request.urlretrieve` for simple file downloads
---

## Iteration 4 - US-004: Implement XPT file parser
- Implemented `read_xpt()` function in `freeT/data.py`
- Function uses pandas `read_sas()` with format='xport' to parse XPT files
- Added error handling for:
  - FileNotFoundError for missing files (with helpful message about download_nhanes())
  - ValueError for wrong file extension (must be .xpt or .XPT)
  - ValueError for invalid/corrupted XPT content
- Created `tests/test_data.py` with 8 unit tests:
  - test_file_not_found_error
  - test_wrong_extension_error
  - test_accepts_path_object
  - test_accepts_string_path
  - test_invalid_xpt_content_error
  - test_lowercase_extension_accepted
  - test_successful_read_with_mock
  - test_returns_dataframe
- All tests pass via `python -m pytest tests/test_data.py -v`
- Learnings for future iterations:
  - pandas `read_sas()` with format='xport' handles XPT files natively
  - Use `unittest.mock` to mock pandas.read_sas for success tests without real XPT files
  - tempfile.NamedTemporaryFile with custom suffix for testing file extension handling
---

## Iteration 5 - US-005: Create NHANES data cleaning pipeline
- Implemented `clean_nhanes_data()` function in `freeT/data.py`
- Function takes tst_df, shbg_df, alb_df DataFrames as input
- Merges datasets on SEQN using inner join
- Unit conversions:
  - TT: ng/dL → nmol/L using ng_dl_to_nmol_l from utils
  - Albumin: g/dL → g/L (multiply by 10)
  - SHBG: already in nmol/L (no conversion needed)
- Outlier removal criteria:
  - TT < 0.5 nmol/L (after conversion)
  - SHBG > 250 nmol/L
  - Albumin < 30 g/L (after conversion)
- Returns DataFrame with standardized columns: seqn, tt_nmoll, shbg_nmoll, alb_gl
- Verbose mode prints cleaning statistics
- Typecheck passes via `py_compile`
- All existing tests pass
- Learnings for future iterations:
  - NHANES column names: LBXTST (testosterone), LBXSHBG (SHBG), LBXSAL (albumin)
  - Albumin in NHANES is in g/dL (not mg/dL), so multiply by 10 for g/L
  - Inner join on SEQN ensures only complete cases are kept
---

